import { useEffect, useMemo, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { Calendar, Clock, Filter, Moon, Sun, Download } from "lucide-react";

// ===== Helper utils
const days = ["Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"]; // dim retiré par défaut
const startHour = 8; // 08:00
const endHour = 20;  // 20:00

function timeToMinutes(t) {
  const [h, m] = t.split(":").map(Number);
  return h * 60 + m;
}

function minutesToLabel(min) {
  const h = Math.floor(min / 60);
  const m = (min % 60).toString().padStart(2, "0");
  return `${h}h${m === "00" ? "" : m}`;
}

function classColor(name) {
  // deterministic pastel color from string
  let hash = 0;
  for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
  const hue = Math.abs(hash) % 360;
  return `hsla(${hue} 70% 50% / 0.9)`;
}

// ===== Sample data (replace with your real data)
const sampleEvents = [
  { id: 1, title: "Deep Learning", day: 1, start: "09:00", end: "11:00", room: "B204", teacher: "Dr. Martin", group: "A", track: "IA" },
  { id: 2, title: "NLP avancé", day: 1, start: "11:15", end: "12:45", room: "B204", teacher: "Mme. Rossi", group: "A", track: "IA" },
  { id: 3, title: "Économétrie", day: 2, start: "10:00", end: "12:00", room: "A112", teacher: "Pr. Durand", group: "B", track: "Stats" },
  { id: 4, title: "Projet Data", day: 3, start: "13:30", end: "17:30", room: "Lab 3", teacher: "Encadrement", group: "A+B", track: "Projet" },
  { id: 5, title: "Vision par ordi", day: 4, start: "08:30", end: "10:30", room: "C310", teacher: "Dr. Chen", group: "B", track: "IA" },
  { id: 6, title: "Systèmes distribués", day: 5, start: "15:00", end: "18:00", room: "D007", teacher: "Mme. Lopez", group: "A", track: "Infra" },
  { id: 7, title: "Anglais Tech", day: 2, start: "14:00", end: "16:00", room: "E201", teacher: "Ms. Baker", group: "A+B", track: "Soft" },
];

// ===== Main Component
export default function TimetableApp() {
  const [dark, setDark] = useState(false);
  const [events, setEvents] = useState(sampleEvents);
  const [filters, setFilters] = useState({ group: "All", teacher: "All", track: "All" });
  const [now, setNow] = useState(new Date());
  const [mobileDay, setMobileDay] = useState(() => {
    const d = new Date().getDay();
    return Math.max(1, Math.min(6, d)); // 1-6
  });

  // Persist dark mode
  useEffect(() => {
    const saved = localStorage.getItem("tt_dark");
    if (saved) setDark(saved === "1");
  }, []);
  useEffect(() => {
    localStorage.setItem("tt_dark", dark ? "1" : "0");
    document.documentElement.classList.toggle("dark", dark);
  }, [dark]);

  // Tick clock each minute
  useEffect(() => {
    const i = setInterval(() => setNow(new Date()), 30_000);
    return () => clearInterval(i);
  }, []);

  // Derived filter lists
  const groups = useMemo(() => ["All", ...new Set(events.map(e => e.group))], [events]);
  const teachers = useMemo(() => ["All", ...new Set(events.map(e => e.teacher))], [events]);
  const tracks = useMemo(() => ["All", ...new Set(events.map(e => e.track))], [events]);

  const filtered = useMemo(() => events.filter(e =>
    (filters.group === "All" || e.group === filters.group) &&
    (filters.teacher === "All" || e.teacher === filters.teacher) &&
    (filters.track === "All" || e.track === filters.track)
  ), [events, filters]);

  // Next class card
  const nextClass = useMemo(() => {
    const today = new Date();
    const weekday = today.getDay(); // 0-6 (Mon is 1)
    const nowM = today.getHours() * 60 + today.getMinutes();
    // Build upcoming list for the next 7 days
    const upcoming = [];
    for (let d = 0; d < 7; d++) {
      const checkDay = ((weekday + d + 6) % 7) + 1; // map JS day to 1-7 with Mon=1
      filtered
        .filter(e => e.day === checkDay)
        .forEach(e => {
          const t = timeToMinutes(e.start);
          const deltaMin = d * 24 * 60 + (t - nowM);
          if (deltaMin >= 0) upcoming.push({ e, deltaMin, inDays: d });
        });
    }
    upcoming.sort((a,b) => a.deltaMin - b.deltaMin);
    return upcoming[0]?.e || null;
  }, [filtered, now]);

  const hours = useMemo(() => {
    const arr = [];
    for (let h = startHour; h <= endHour; h++) arr.push(h);
    return arr;
  }, []);

  // ICS export (all filtered events for the week)
  function downloadICS() {
    const dt = new Date();
    const weekStart = startOfWeek(dt);
    const ics = [
      "BEGIN:VCALENDAR",
      "VERSION:2.0",
      "PRODID:-//Master Schedule//FR",
    ];
    filtered.forEach((e, idx) => {
      const start = dayTimeToDate(weekStart, e.day, e.start);
      const end = dayTimeToDate(weekStart, e.day, e.end);
      ics.push(
        "BEGIN:VEVENT",
        `UID:${idx}-${Date.now()}@master-schedule`,
        `DTSTAMP:${toICS(new Date())}`,
        `DTSTART:${toICS(start)}`,
        `DTEND:${toICS(end)}`,
        `SUMMARY:${escapeICS(e.title)} (${e.room})`,
        `DESCRIPTION:Prof: ${escapeICS(e.teacher)}\\nGroupe: ${escapeICS(e.group)}\\nParcours: ${escapeICS(e.track)}`,
        "END:VEVENT"
      );
    });
    ics.push("END:VCALENDAR");
    const blob = new Blob([ics.join("\n")], { type: "text/calendar;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "emploi_du_temps.ics";
    a.click();
    URL.revokeObjectURL(url);
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-indigo-950 text-slate-100 selection:bg-indigo-500/40 selection:text-white">
      <Aura />
      <header className="sticky top-0 z-30 backdrop-blur-xl bg-slate-900/60 border-b border-white/10">
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
          <Calendar className="w-6 h-6"/>
          <h1 className="text-lg sm:text-2xl font-semibold tracking-tight">Emploi du temps – Master</h1>
          <div className="ml-auto flex items-center gap-2">
            <FilterBar
              groups={groups}
              teachers={teachers}
              tracks={tracks}
              filters={filters}
              onChange={setFilters}
            />
            <button onClick={downloadICS} className="hidden sm:inline-flex items-center gap-2 rounded-2xl border border-white/10 px-3 py-2 text-sm hover:bg-white/10 transition">
              <Download className="w-4 h-4"/> Export .ics
            </button>
            <button
              onClick={() => setDark(v => !v)}
              className="inline-flex items-center justify-center rounded-2xl border border-white/10 p-2 hover:bg-white/10 transition"
              aria-label="Basculer le thème"
            >
              {dark ? <Sun className="w-5 h-5"/> : <Moon className="w-5 h-5"/>}
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 pb-16">
        <div className="grid lg:grid-cols-3 gap-4 mt-6">
          <div className="lg:col-span-2">
            <TimetableGrid events={filtered} mobileDay={mobileDay} setMobileDay={setMobileDay} />
          </div>
          <div className="lg:col-span-1 space-y-4">
            <NextClassCard event={nextClass} />
            <TipsCard />
          </div>
        </div>
      </main>
    </div>
  );
}

// ===== Components
function FilterBar({ groups, teachers, tracks, filters, onChange }) {
  const Chip = ({ label, value, current, onClick }) => (
    <button
      onClick={onClick}
      className={`text-xs rounded-2xl px-3 py-1.5 border border-white/10 hover:bg-white/10 transition ${current === value ? "bg-white/10" : ""}`}
    >{label}</button>
  );

  return (
    <div className="hidden md:flex items-center gap-2">
      <div className="flex items-center gap-1">
        {groups.map(g => (
          <Chip key={g} label={`G:${g}`} value={g} current={filters.group} onClick={() => onChange(f => ({...f, group: g}))} />
        ))}
      </div>
      <div className="w-px h-6 bg-white/10 mx-1"/>
      <div className="flex items-center gap-1">
        {tracks.map(t => (
          <Chip key={t} label={t} value={t} current={filters.track} onClick={() => onChange(f => ({...f, track: t}))} />
        ))}
      </div>
      <div className="w-px h-6 bg-white/10 mx-1"/>
      <div className="flex items-center gap-1">
        {teachers.map(t => (
          <Chip key={t} label={shortName(t)} value={t} current={filters.teacher} onClick={() => onChange(f => ({...f, teacher: t}))} />
        ))}
      </div>
    </div>
  );
}

function TimetableGrid({ events, mobileDay, setMobileDay }) {
  const hourHeight = 64; // px per hour
  const gridHours = [];
  for (let h = startHour; h <= endHour; h++) gridHours.push(h);

  const todayJS = new Date().getDay(); // 0-6
  const today = Math.max(1, Math.min(6, todayJS));

  const byDay = useMemo(() => {
    const map = new Map();
    for (let d = 1; d <= 6; d++) map.set(d, []);
    events.forEach(e => map.get(e.day)?.push(e));
    // sort by start time
    for (let d = 1; d <= 6; d++) map.get(d).sort((a,b) => timeToMinutes(a.start) - timeToMinutes(b.start));
    return map;
  }, [events]);

  // current time line position
  const now = new Date();
  const isTodayInRange = todayJS !== 0; // not Sunday
  const nowM = now.getHours() * 60 + now.getMinutes();
  const lineTop = ((nowM - startHour * 60) / 60) * hourHeight;

  return (
    <div className="rounded-3xl border border-white/10 overflow-hidden relative bg-white/5 backdrop-blur-xl">
      {/* Mobile day tabs */}
      <div className="grid grid-cols-6 gap-1 p-2 border-b border-white/10 lg:hidden">
        {days.map((d, i) => (
          <button key={d} onClick={() => setMobileDay(i+1)}
            className={`text-sm rounded-xl py-2 ${mobileDay === i+1 ? "bg-white/10" : "hover:bg-white/5"}`}>{d}</button>
        ))}
      </div>

      <div className="hidden lg:grid grid-cols-[80px_repeat(6,1fr)]">
        {/* Hour rail */}
        <div className="relative">
          {gridHours.map((h, idx) => (
            <div key={h} className="h-16 border-b border-white/5 text-xs text-slate-300/90 flex items-start justify-end pr-2">
              <div className="translate-y-[-8px]">{h}:00</div>
            </div>
          ))}
        </div>
        {/* Day columns */}
        {days.map((label, di) => (
          <div key={label} className="relative">
            {gridHours.map((h) => (
              <div key={h} className="h-16 border-b border-white/5"/>
            ))}
            {/* Today highlight */}
            {today === di+1 && (
              <div className="absolute inset-0 bg-indigo-400/5 pointer-events-none" />
            )}
            {/* Now line */}
            {today === di+1 && isTodayInRange && now.getHours()>=startHour && now.getHours()<=endHour && (
              <motion.div
                initial={false}
                animate={{ top: lineTop }}
                transition={{ type: "spring", stiffness: 80, damping: 20 }}
                className="absolute left-0 right-0 h-[2px] bg-indigo-400/70 shadow-[0_0_20px_#818cf880]" />
            )}
            {/* Events */}
            <div className="absolute inset-0">
              {byDay.get(di+1)?.map(e => (
                <ClassBlock key={e.id} e={e} hourHeight={hourHeight} />
              ))}
            </div>
            {/* Day label */}
            <div className="absolute top-2 left-2 text-sm font-medium text-slate-200/80">{label}</div>
          </div>
        ))}
      </div>

      {/* Mobile column */}
      <div className="lg:hidden relative">
        <div className="relative">
          {gridHours.map((h) => (
            <div key={h} className="h-16 border-b border-white/5 relative">
              <div className="absolute left-2 top-[-8px] text-xs text-slate-300/90">{h}:00</div>
            </div>
          ))}
          <div className="absolute inset-0">
            {byDay.get(mobileDay)?.map(e => (
              <ClassBlock key={e.id} e={e} hourHeight={hourHeight} />
            ))}
          </div>
          {/* Today line on mobile */}
          {today === mobileDay && now.getHours()>=startHour && now.getHours()<=endHour && (
            <motion.div initial={false} animate={{ top: lineTop }} transition={{ type: "spring", stiffness: 80, damping: 20 }} className="absolute left-0 right-0 h-[2px] bg-indigo-400/70" />
          )}
        </div>
      </div>
    </div>
  );
}

function ClassBlock({ e, hourHeight }) {
  const startM = timeToMinutes(e.start);
  const endM = timeToMinutes(e.end);
  const top = ((startM - startHour * 60) / 60) * hourHeight;
  const height = ((endM - startM) / 60) * hourHeight - 6; // gap
  const bg = e.color || classColor(e.title + e.room);

  return (
    <motion.div
      initial={{ opacity: 0, y: 6 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.3 }}
      className="absolute left-1 right-1 rounded-2xl p-3 text-sm shadow-lg border border-white/10 overflow-hidden"
      style={{ top, height, background: `linear-gradient(135deg, ${bg}, ${bg.replace("0.9", "0.7")})` }}
      title={`${e.title} — ${e.start}–${e.end} | ${e.room}`}
    >
      <div className="flex items-center justify-between gap-2">
        <div className="font-semibold leading-tight drop-shadow">{e.title}</div>
        <span className="text-xs bg-black/20 rounded-full px-2 py-0.5">{e.room}</span>
      </div>
      <div className="mt-1 text-xs opacity-90">{e.start} – {e.end}</div>
      <div className="text-xs opacity-90">{e.teacher} • G{e.group} • {e.track}</div>
    </motion.div>
  );
}

function NextClassCard({ event }) {
  if (!event) return (
    <div className="rounded-3xl border border-white/10 p-4 bg-white/5 backdrop-blur-xl">
      <div className="flex items-center gap-2"><Clock className="w-5 h-5"/><p className="font-medium">Aucun cours à venir</p></div>
      <p className="text-sm opacity-80 mt-1">Tu es à jour. Profite ✨</p>
    </div>
  );

  const startM = timeToMinutes(event.start);
  const endM = timeToMinutes(event.end);
  const now = new Date();
  const nowM = now.getHours() * 60 + now.getMinutes();
  const mins = startM - nowM + (event.day - Math.max(1, Math.min(6, now.getDay()))) * 24 * 60;
  const hrs = Math.floor(mins / 60);
  const rem = Math.max(0, mins % 60);

  return (
    <div className="rounded-3xl border border-white/10 p-5 bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-xl">
      <div className="flex items-center gap-2 mb-2"><Clock className="w-5 h-5"/><p className="font-semibold">Prochain cours</p></div>
      <div className="text-lg font-semibold">{event.title}</div>
      <div className="text-sm opacity-90">{days[event.day-1]} • {event.start} – {event.end} • {event.room}</div>
      <div className="text-sm opacity-90">{event.teacher} • G{event.group} • {event.track}</div>
      <div className="mt-3 text-sm">
        <span className="opacity-80">Commence dans </span>
        <span className="font-semibold">{hrs > 0 ? `${hrs}h` : ""}{rem} min</span>
      </div>
    </div>
  );
}

function TipsCard() {
  return (
    <div className="rounded-3xl border border-white/10 p-5 bg-white/5 backdrop-blur-xl">
      <p className="text-sm opacity-90">Astuce : ajoute la page à l’écran d’accueil sur mobile pour accéder à l’emploi du temps en 1 tap. Tu peux aussi exporter en <span className="font-medium">.ics</span> et l’importer dans Google/Apple Calendar.</p>
    </div>
  );
}

function Aura() {
  return (
    <div aria-hidden className="pointer-events-none fixed inset-0 -z-10 overflow-hidden">
      <div className="absolute -top-20 -left-20 w-[40rem] h-[40rem] rounded-full bg-purple-500/20 blur-3xl" />
      <div className="absolute -bottom-20 -right-20 w-[35rem] h-[35rem] rounded-full bg-indigo-500/20 blur-3xl" />
      <div className="absolute top-1/3 left-1/2 -translate-x-1/2 w-[50rem] h-[50rem] rounded-full bg-cyan-400/10 blur-3xl" />
    </div>
  );
}

// ====== Date helpers for ICS
function startOfWeek(d) {
  const dt = new Date(d);
  const day = (dt.getDay() + 6) % 7; // Mon=0
  dt.setDate(dt.getDate() - day);
  dt.setHours(0,0,0,0);
  return dt;
}
function dayTimeToDate(weekStart, day, hhmm) {
  const [h, m] = hhmm.split(":").map(Number);
  const dt = new Date(weekStart);
  dt.setDate(dt.getDate() + (day - 1));
  dt.setHours(h, m, 0, 0);
  return dt;
}
function toICS(date) {
  const pad = (n) => String(n).padStart(2, "0");
  return (
    date.getUTCFullYear().toString() +
    pad(date.getUTCMonth() + 1) +
    pad(date.getUTCDate()) +
    "T" +
    pad(date.getUTCHours()) +
    pad(date.getUTCMinutes()) +
    pad(date.getUTCSeconds()) +
    "Z"
  );
}
function escapeICS(s) {
  return String(s).replace(/\\n/g, "\\n").replace(/,|;|\\\/g, (m) => `\\${m}`);
}
function shortName(n) {
  return n.replace(/(Dr\.|Mme\.|Mr\.|Ms\.|Pr\.)\s*/gi, "");
}
